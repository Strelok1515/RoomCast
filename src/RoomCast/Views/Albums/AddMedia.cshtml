@using RoomCast.Models
@{
    ViewData["Title"] = "Add Media to Album";
    var files = ViewBag.Files as List<MediaFile>;
    var albumId = ViewBag.AlbumId as int? ?? 0;
}

<div class="mb-8">
    <h2 class="text-3xl font-semibold text-slate-900">Add Media to Album</h2>
    <p class="text-slate-500 text-sm">Select one or multiple media items to add.</p>
    <br />
</div>

<a asp-action="Index"
   class="inline-flex items-center text-sm text-slate-600 hover:text-slate-800 mb-6">
    <i class="bi bi-arrow-left me-1"></i> Back to Albums 
</a>


<form asp-action="AddMedia" method="post" id="mediaForm">
    @Html.AntiForgeryToken()

    <input type="hidden" name="albumId" value="@albumId" />

    <!-- This will contain multiple IDs -->
    <div id="selectedFileContainer"></div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

        @foreach (var file in files)
        {
            var isImage = file.FileType == "Picture" || file.FileType == "Image";
            var isVideo = file.FileType == "Video";
            var isDocument = file.FileType == "Document";

            <div class="media-item cursor-pointer rounded-2xl bg-white shadow border border-transparent hover:shadow-lg transition relative"
                 data-file-id="@file.FileId">

                <!-- Selection checkmark -->
                <div class="absolute top-3 right-3 selection-icon hidden bg-indigo-600 h-8 w-8 rounded-full
                                    flex items-center justify-center shadow text-white">
                    <i class="bi bi-check-lg text-lg"></i>
                </div>

                <!-- Thumbnail -->
                <div class="h-48 w-full overflow-hidden rounded-t-2xl bg-slate-100 flex items-center justify-center">
                    @if (isImage)
                    {
                        <img src="@file.FilePath" class="w-full h-full object-cover" />
                    }
                    else if (isVideo)
                    {
                        <video class="w-full h-full object-cover" muted preload="metadata">
                            <source src="@file.FilePath" />
                        </video>
                    }
                    else if (isDocument)
                    {
                        <div class="flex flex-col items-center text-slate-500">
                            <i class="bi bi-file-earmark-text text-5xl"></i>
                            <span class="text-xs mt-1">@file.FileFormat?.ToUpper()</span>
                        </div>
                    }
                </div>

                <!-- Title -->
                <div class="p-4">
                    <p class="font-semibold text-slate-800 truncate">@file.Title</p>
                    <p class="text-xs uppercase text-slate-500">@file.FileType</p>
                </div>

            </div>
        }

    </div>
    <br />

    <!-- Add spacing before the button -->
    <div class="mt-10 flex justify-end">
        <button type="submit"
                class="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-500 transition">
            Add Selected Media
        </button>
    </div>
</form>

@section Scripts {
    <script>
        let selectedFiles = new Set();

        document.querySelectorAll('.media-item').forEach(card => {
            card.addEventListener('click', () => {
                const fileId = card.dataset.fileId;

                if (selectedFiles.has(fileId)) {
                    // Unselect
                    selectedFiles.delete(fileId);
                    card.classList.remove("border-indigo-600", "ring-2", "ring-indigo-300");
                    card.querySelector('.selection-icon').classList.add("hidden");
                } else {
                    // Select
                    selectedFiles.add(fileId);
                    card.classList.add("border-indigo-600", "ring-2", "ring-indigo-300");
                    card.querySelector('.selection-icon').classList.remove("hidden");
                }

                rebuildHiddenInputs();
            });
        });

        function rebuildHiddenInputs() {
            const container = document.getElementById("selectedFileContainer");
            container.innerHTML = ""; // clear

            selectedFiles.forEach(id => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "fileIds";   // IMPORTANT for binding List<int>
                input.value = id;
                container.appendChild(input);
            });
        }

        document.getElementById("mediaForm").addEventListener("submit", function (e) {
            if (selectedFiles.size === 0) {
                alert("Please select at least one media item.");
                e.preventDefault();
            }
        });
    </script>
}
